. ./config
filteredtags=
starttag=
commits=
cveid=

find_commit_cve ()
{
        commits=""
        log=$(git log --grep="$cveid" -i)
        if [ "$log" != "" ]
        then
            commits=$(echo "$log" | grep "^commit"|cut -d" " -f2 | tr '\n' ' ')
        fi

        for j in $commits
        do
            tags=$(git tag --list --sort=taggerdate --contains $j)
            filteredtags=$(echo "$tags"|grep -E "$TAGS_REGEX" | tr '\n' ' ')
            starttag=$(echo "$tags"| head -1)
        done
}

get_tags ()
{
    for i in $@
    do
        tags=$(git tag --list --sort=taggerdate --contains $i)
        filteredtags=$(echo "$tags"|grep -E "$TAGS_REGEX" | tr '\n' ' ')
        starttag=$(echo "$tags"| head -1)
    done
}

add_multi_to_report ()
{
    for var in $@
    do
        echo "$var</br>" >> report.html
    done
}
add_refs_to_report ()
{
    for ref in $@
    do
        echo "<a href="$ref" target="_blank">$ref</a></br>" >> report.html
    done
}

if [ "$REPODIR" == "" ]
then
    git clone $GIT_REPO_URL repodir
    REPODIR="./repodir"
fi

curdir=`pwd`

echo "<html><head><style>
table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 100%;
}

td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
}

tr:nth-child(even) {
    background-color: #dddddd;
}
</style>
</head>" > report.html
echo "<body>" >> report.html
echo "<table>" >> report.html

echo "<tr> 
        <th>S.No</th> 
        <th>CVEID</th> 
        <th>Description</th> 
        <th>References</th> 
        <th>Commits</th> 
        <th>Fix started From</th>
        <th>Tags with Fix</th>
        </tr>" >> report.html

cvecount=$(cat $CVE_IDS_FILE| wc -l)
count=0

for cveid in $(cat $CVE_IDS_FILE)
do
    commits=
    refs=
    desc=
    filteredtags=
    starttag=
    commits=

    ((count++))

    echo -ne "\rProcessing $cveid [$count/$cvecount]"
    file=$cveid
    wget https://nvd.nist.gov/vuln/detail/$cveid > /dev/null 2>&1

    if [ -f $file ]
    then
        sed -i "s/\r//g" $file
        desc=$(cat $file | grep "\"vuln-description\"" |sed -e 's/<[^>]*>//g' -e 's/^ *//g')
        refs=$(cat $file | grep "vuln-hyperlinks-link-.*\"" | sed -e 's/<[^>]*>//g' -e 's/^ *//g')
        commits=$(echo "$refs" | grep "$GIT_REPO_PATTERN" | awk -F${COMMIT_PATTERN} '{print $2}')

        cd $REPODIR
        if [ "$commits" != "" ]
        then
            get_tags "$commits"
        else
            find_commit_cve
        fi
        cd $curdir

        echo "<tr>" >> report.html
        echo "<td>" >> report.html
        echo $count >> report.html
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        echo $cveid >> report.html
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        echo $desc >> report.html
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        add_refs_to_report "$refs"
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        add_multi_to_report "$commits"
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        echo "$starttag" >> report.html
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        add_multi_to_report "$filteredtags"
        echo "</td>" >> report.html
        echo "</tr>" >> report.html
        rm -rf $file
    else
        echo "<tr>" >> report.html
        echo "<td>" >> report.html
        echo $count >> report.html
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        echo $cveid >> report.html
        echo "</td>" >> report.html
        echo "<td>" >> report.html
        echo "No page found in https://nvd.nist.gov" >> report.html
        echo "</td>" >> report.html
        echo "</tr>" >> report.html
    fi
done
echo "</table></body></html>" >> report.html
